# woniu

### 👥 成员与分工
* **谢先旺**：RK3568 移植、WEB、云服务器部署、主程序网关开发
* **祁异凡**：STM32 开发
* **孙宇豪**：QT 开发

---

### 📝 项目日志

**#2026-02-03**
1. **移植 mjpg-streamer, sqlite, json, mongoose, mqtt**
   - **遇到的问题**：第三方库版本过老导致语法不匹配，编译不通过。
   - **解决方案**：通过手动修改语法完成编译。
2. **OV5695 摄像头推流**
   - **遇到的问题**：支持的视频格式与 mjpg-streamer 不匹配，无法推流。
   - **解决方案**：改用 USB 自带驱动摄像头，并尝试其他视频推流格式。

**#2026-02-05**
1. **主程序开发，实现 WEB 端端口通信，视频推流**
   - **遇到的问题**：交叉编译的库不匹配。
   - **解决方案**：下载更高版本的库，匹配语法和功能。
2. **OV5695 摄像头推流**
   - **遇到的问题**：http 端到端的通信，json 格式。
   - **解决方案**：端口隔离。

**#2026-02-07**
1. **主程序开发，实现 MQTT 通信，获取传感器数据**
   - **遇到的问题**：RK3568，MQTT 无法连接。
   - **解决方案**：一步步排查问题。先在本地部署 MQTT 服务器尝试本地回环通信，发现主程序正常运行；再排查服务器 MQTT 是否能正常连接，其他设备使用 MQTT 连接服务器正常；最后排查 RK3568 网络问题，通过修改 RK3568 的 DNS 解决了问题。

**#2026-02-08**
1. **主程序开发，实现录像和拍照功能**
   - **遇到的问题**：录像和 web 推流抢占摄像头。
   - **解决方案**：在主程序由摄像头类接管分发资源。

**#2026-02-14**
 **重构音视频录像架构，实现 1080P 30FPS 高清丝滑录像**
   - **遇到的问题**：
     - **录像加速/乱序**：由于 OpenCV 软编码（Software Encoding）极其消耗 CPU，导致 1080P 录像帧率严重不足，播放时出现“快进效应”且时间轴错乱（秒表顺序跳跃）。
     - **硬件加速兼容性**：尝试调用 RK3568 的 MPP 硬件加速插件，但因 OpenCV 内存类型与硬件 DMA 内存不匹配，导致 RGA 内存映射失败（`rga2_mmu: RGA2 failed to get pte`）。
   - **解决方案**：
     - **流直写技术（Stream Copy）**：放弃 OpenCV 录像，改为调用系统内置的 **FFmpeg** 引擎。通过 `-c:v copy` 参数直接封装 `mjpg-streamer` 已经压缩好的 JPEG 数据包。
     - **零负载录像**：该方案实现了 **0 CPU 负载、30FPS 满血录像**，彻底解决了预览与录像互相干扰的问题。

### ✅ 项目进度【已完成】
* 交叉编译环境搭建。
* 五大第三方库（FRP、mjpg-streamer、SQLite、Mongoose、MQTT）移植。
* USB 摄像头硬件取流。
* FRP 公网穿透访问、云服务器 MQTT 部署与通信。
* **[2.14新增]** FFmpeg 流直写录像方案，支持 1080P 30FPS 丝滑录像。
* **[2.14新增]** C++ 主程序异步管理外部推流/录像进程。

---

### 🚀 下一步计划
1. 测试单片机数据，QT客户端连接
